<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CARDS | Intelligent SOC Platform</title>

    <!-- This links to your separate CSS file -->
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header>
      <!-- Website Logo Name -->
      <div class="logo">
        <div class="status-indicator"></div>
        CARDS
        <span
          style="
            font-size: 0.7em;
            color: var(--text-muted);
            border: 1px solid #333;
            padding: 0 4px;
            border-radius: 3px;
          "
          >v2.0</span
        >
      </div>
      <div style="display: flex; gap: 15px">
        <button class="btn" onclick="App.toggleSimulation()" id="simBtn">
          Start Simulation
        </button>
        <button class="btn btn-danger" onclick="App.triggerSOS()">
          PANIC MODE
        </button>
      </div>
    </header>

    <div class="main-container">
      <!-- SIDEBAR -->
      <nav class="sidebar panel">
        <div class="panel-title">Navigation</div>
        <div class="nav-item active">Dashboard</div>
        <div class="nav-item">Threat Intelligence</div>
        <div class="nav-item">Case Management</div>
        <div class="nav-item">System Settings</div>

        <div class="panel-title" style="margin-top: 30px">System Health</div>
        <div
          style="
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 5px;
          "
        >
          CPU Load
        </div>
        <div
          style="
            width: 100%;
            height: 4px;
            background: #333;
            border-radius: 2px;
            margin-bottom: 15px;
          "
        >
          <div
            style="width: 34%; height: 100%; background: var(--accent-primary)"
          ></div>
        </div>
        <div
          style="
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 5px;
          "
        >
          Memory
        </div>
        <div
          style="width: 100%; height: 4px; background: #333; border-radius: 2px"
        >
          <div
            style="width: 62%; height: 100%; background: var(--accent-warn)"
          ></div>
        </div>

        <div class="panel-title" style="margin-top: 30px">Quick Actions</div>
        <button
          class="btn btn-sm"
          style="width: 100%; margin-bottom: 10px"
          onclick="App.generateReport()"
        >
          Download PDF Report
        </button>
      </nav>

      <!-- MAP SECTION -->
      <section class="map-section">
        <canvas id="threatMap"></canvas>
        <div class="overlay-stats">
          <div class="stat-card">
            <div class="stat-val text-danger" id="attackCount">0</div>
            <div class="stat-label">TOTAL ATTACKS</div>
          </div>
          <div class="stat-card">
            <div class="stat-val text-warn" id="riskScore">0</div>
            <div class="stat-label">RISK SCORE</div>
          </div>
          <div class="stat-card">
            <div class="stat-val text-info" id="logsPerSec">0</div>
            <div class="stat-label">LOGS / SEC</div>
          </div>
        </div>

        <!-- SOAR CONSOLE -->
        <div class="soar-console" id="soarConsole">
          <div style="color: var(--accent-primary); margin-bottom: 5px">
            > SOAR PLAYBOOK EXECUTING...
          </div>
          <div id="soarOutput"></div>
        </div>
      </section>

      <!-- RIGHT PANEL -->
      <aside class="right-panel">
        <!-- JARVIS AI -->
        <div class="ai-box panel">
          <div class="panel-title">
            <span>AI Incident Analyst</span>
            <span class="mono text-success">ONLINE</span>
          </div>
          <div id="ai-terminal">
            <div class="ai-msg">System initialized.</div>
            <div class="ai-msg">Waiting for security events...</div>
          </div>
        </div>

        <!-- ALERT QUEUE -->
        <div class="alert-box panel">
          <div class="panel-title">
            <span>Active Alerts</span>
            <button class="btn btn-sm" onclick="App.clearAlerts()">
              Clear
            </button>
          </div>
          <div class="alert-list" id="alertList">
            <!-- Alerts injected here -->
            <div
              style="
                text-align: center;
                padding: 20px;
                color: var(--text-muted);
              "
            >
              No active threats.
            </div>
          </div>
        </div>
      </aside>

      <!-- LOG TABLE -->
      <section class="log-section panel">
        <div class="panel-title">Universal Log Collector (Normalizer)</div>
        <div class="log-table-container">
          <table id="logTable">
            <thead>
              <tr>
                <th style="width: 150px">Timestamp</th>
                <th style="width: 120px">Source IP</th>
                <th style="width: 120px">Geo-Location</th>
                <th style="width: 100px">Event Type</th>
                <th>Raw Message</th>
                <th style="width: 80px">Action</th>
              </tr>
            </thead>
            <tbody id="logTableBody">
              <!-- Logs injected here -->
            </tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- --- JAVASCRIPT LOGIC --- -->
    <script>
      /*
       * ====================================================================
       * BACKEND SIMULATION & DATA LAYER
       * Note: In a production app, this would be your Node.js/Firebase backend.
       * ====================================================================
       */

      // 1. MITRE ATT&CK Database Simulation
      const MITRE_DB = {
        T1566: { name: "Spearphishing", tactic: "Initial Access" },
        T1110: { name: "Brute Force", tactic: "Credential Access" },
        T1078: { name: "Valid Accounts", tactic: "Defense Evasion" },
        T1041: { name: "Exfiltration Over C2", tactic: "Exfiltration" },
      };

      // 2. The "Scripted" Scenario Data (No Randomization)
      // This ensures your demo tells a consistent story every time.
      const SCENARIO_DATA = [
        {
          type: "auth",
          ip: "192.168.1.50",
          geo: "Internal",
          msg: "User login successful: admin",
          severity: "low",
          mitre: null,
        },
        {
          type: "auth",
          ip: "45.33.22.11",
          geo: "Russia",
          msg: "Failed login attempt",
          severity: "low",
          mitre: "T1110",
        },
        {
          type: "auth",
          ip: "45.33.22.11",
          geo: "Russia",
          msg: "Failed login attempt",
          severity: "low",
          mitre: "T1110",
        },
        {
          type: "auth",
          ip: "45.33.22.11",
          geo: "Russia",
          msg: "Failed login attempt",
          severity: "medium",
          mitre: "T1110",
        },
        {
          type: "auth",
          ip: "45.33.22.11",
          geo: "Russia",
          msg: "Failed login attempt",
          severity: "medium",
          mitre: "T1110",
        },
        {
          type: "auth",
          ip: "45.33.22.11",
          geo: "Russia",
          msg: "Failed login attempt",
          severity: "high",
          mitre: "T1110",
        }, // Trigger 1

        // Time jump logic implied
        {
          type: "auth",
          ip: "45.33.22.11",
          geo: "Russia",
          msg: "Login SUCCESS: admin",
          severity: "critical",
          mitre: "T1078",
        }, // Trigger 2 (Correlation)

        {
          type: "dns",
          ip: "10.0.0.5",
          geo: "Internal",
          msg: "DNS Query: suspicious-domain.com",
          severity: "medium",
          mitre: "T1071",
        },

        {
          type: "file",
          ip: "10.0.0.5",
          geo: "Internal",
          msg: "File downloaded: malware.exe",
          severity: "high",
          mitre: "T1105",
        },

        {
          type: "net",
          ip: "10.0.0.5",
          geo: "Internal",
          msg: "Large data transfer to 45.33.22.11",
          severity: "critical",
          mitre: "T1041",
        }, // Exfiltration
      ];

      // 3. Backend Class (Logic Controller)
      class BackendController {
        constructor() {
          this.state = {
            totalLogs: 0,
            riskScore: 0,
            attacksBlocked: 0,
            activeAlerts: [],
            logHistory: [],
          };
          this.correlationRules = {
            bruteForceSuccess: (history) => {
              const failures = history.filter(
                (l) => l.ip === "45.33.22.11" && l.msg.includes("Failed")
              ).length;
              const success = history.find(
                (l) => l.ip === "45.33.22.11" && l.msg.includes("SUCCESS")
              );
              return failures >= 5 && success ? true : false;
            },
          };
        }

        // Simulate data ingestion
        async ingestLog(index) {
          if (index >= SCENARIO_DATA.length) return null; // End of simulation

          const raw = SCENARIO_DATA[index];
          const enrichedLog = {
            id: Date.now() + Math.random(),
            timestamp: new Date().toLocaleTimeString(),
            ...raw,
          };

          // Normalizer Logic (Convert messy strings to clean data)
          this.state.logHistory.push(enrichedLog);
          this.state.totalLogs++;

          // Risk Calculation Algorithm
          const severityWeight = { low: 1, medium: 5, high: 10, critical: 25 };
          this.state.riskScore += severityWeight[enrichedLog.severity] || 0;

          return enrichedLog;
        }

        checkCorrelations(newLog) {
          // Rule: If 5 failures followed by success -> CRITICAL ALERT
          if (newLog.ip === "45.33.22.11" && newLog.msg.includes("SUCCESS")) {
            this.createAlert({
              title: "Coordinated Brute Force Attack",
              desc: "Detected 5 failed logins followed by a successful connection from Russia.",
              severity: "critical",
              mitre: "T1110",
              ip: newLog.ip,
              recommendation:
                "Block IP 45.33.22.11 immediately and force password reset.",
            });
          }

          // Rule: Exfiltration
          if (newLog.type === "net" && newLog.msg.includes("Large data")) {
            this.createAlert({
              title: "Data Exfiltration Detected",
              desc: "Unusually large traffic volume sent to known bad actor IP.",
              severity: "critical",
              mitre: "T1041",
              ip: newLog.ip,
              recommendation: "Isolate Host 10.0.0.5 from network.",
            });
          }
        }

        createAlert(details) {
          const alert = {
            ...details,
            id: Math.random().toString(36).substr(2, 9),
            status: "open",
          };
          this.state.activeAlerts.unshift(alert);
          // Limit alerts to last 5
          if (this.state.activeAlerts.length > 5) this.state.activeAlerts.pop();
          return alert;
        }

        // Simulate VirusTotal Enrichment
        async enrichIP(ip) {
          // Mocking a network request delay
          return new Promise((resolve) => {
            setTimeout(() => {
              resolve({
                ip: ip,
                score: 8 / 10, // Malicious
                categories: ["C2 Server", "Botnet"],
                lastSeen: "2 mins ago",
              });
            }, 800);
          });
        }

        async executePlaybook(action, target) {
          const steps = [
            `Parsing target ${target}...`,
            `Checking firewall rules...`,
            `Applying rule: ${action}...`,
            `Verifying enforcement...`,
            `SUCCESS: Action completed.`,
          ];
          return steps;
        }
      }

      /*
       * ====================================================================
       * FRONTEND UI & INTERACTION
       * ====================================================================
       */

      class FrontendApp {
        constructor() {
          this.backend = new BackendController();
          this.isSimulating = false;
          this.simInterval = null;
          this.scenarioIndex = 0;
          this.mapCanvas = document.getElementById("threatMap");
          this.ctx = this.mapCanvas.getContext("2d");

          this.resizeCanvas();
          window.addEventListener("resize", () => this.resizeCanvas());
          this.initMap();
          this.loopMap(); // Start animation loop
        }

        // --- MAP VISUALIZATION (2D Canvas) ---
        resizeCanvas() {
          this.mapCanvas.width = this.mapCanvas.parentElement.clientWidth;
          this.mapCanvas.height = this.mapCanvas.parentElement.clientHeight;
        }

        initMap() {
          // Draw initial grid background
          this.drawGrid();
        }

        drawGrid() {
          const w = this.mapCanvas.width;
          const h = this.mapCanvas.height;
          this.ctx.clearRect(0, 0, w, h);
          this.ctx.strokeStyle = "#1e293b";
          this.ctx.lineWidth = 1;

          // Draw Grid
          for (let x = 0; x < w; x += 40) {
            this.ctx.beginPath();
            this.ctx.moveTo(x, 0);
            this.ctx.lineTo(x, h);
            this.ctx.stroke();
          }
          for (let y = 0; y < h; y += 40) {
            this.ctx.beginPath();
            this.ctx.moveTo(0, y);
            this.ctx.lineTo(w, y);
            this.ctx.stroke();
          }

          // Draw "HQ" in center
          const cx = w / 2;
          const cy = h / 2;

          // Radar pulse effect
          const time = Date.now() / 1000;
          const radius = (time % 2) * 100;
          const alpha = 1 - radius / 200;

          this.ctx.beginPath();
          this.ctx.arc(cx, cy, radius, 0, Math.PI * 2);
          this.ctx.strokeStyle = `rgba(0, 242, 255, ${alpha})`;
          this.ctx.stroke();

          this.ctx.fillStyle = "#0f0";
          this.ctx.beginPath();
          this.ctx.arc(cx, cy, 5, 0, Math.PI * 2);
          this.ctx.fill();

          this.ctx.fillStyle = "#fff";
          this.ctx.font = "12px monospace";
          this.ctx.fillText("HQ (US-EAST)", cx + 10, cy + 4);
        }

        drawAttackLine(fromX, fromY) {
          const w = this.mapCanvas.width;
          const h = this.mapCanvas.height;
          const cx = w / 2;
          const cy = h / 2;

          // Simple coordinates for countries (Simulated for 2D grid)
          // Russia: Top Right, China: Right, US: Center, etc.
          const coords = {
            Russia: { x: w * 0.8, y: h * 0.2 },
            China: { x: w * 0.85, y: h * 0.4 },
            Internal: { x: cx, y: cy },
          };

          const target = coords[fromY] || {
            x: Math.random() * w,
            y: Math.random() * h,
          };

          this.ctx.beginPath();
          this.ctx.moveTo(target.x, target.y);
          this.ctx.lineTo(cx, cy);
          this.ctx.strokeStyle = "#ff0055";
          this.ctx.lineWidth = 2;
          this.ctx.stroke();

          // Draw explosion at HQ
          this.ctx.fillStyle = "rgba(255, 0, 85, 0.5)";
          this.ctx.beginPath();
          this.ctx.arc(cx, cy, 20, 0, Math.PI * 2);
          this.ctx.fill();
        }

        loopMap() {
          this.drawGrid();
          requestAnimationFrame(() => this.loopMap());
        }

        // --- SIMULATION CONTROL ---
        toggleSimulation() {
          const btn = document.getElementById("simBtn");
          if (this.isSimulating) {
            clearInterval(this.simInterval);
            btn.innerText = "Resume Simulation";
            btn.classList.remove("btn-danger");
          } else {
            this.simInterval = setInterval(() => this.tick(), 2000); // New log every 2 seconds
            btn.innerText = "Pause Simulation";
            btn.classList.add("btn-danger");
            this.writeAI(
              "Simulation sequence initiated. Monitoring traffic patterns..."
            );
          }
          this.isSimulating = !this.isSimulating;
        }

        async tick() {
          if (this.scenarioIndex >= SCENARIO_DATA.length) {
            this.writeAI("Simulation sequence completed. Awaiting next batch.");
            this.toggleSimulation();
            this.scenarioIndex = 0; // Reset for demo purposes
            return;
          }

          const log = await this.backend.ingestLog(this.scenarioIndex);
          this.scenarioIndex++;

          if (log) {
            this.updateStats();
            this.addLogToTable(log);
            this.backend.checkCorrelations(log);
            this.renderAlerts();

            // Visual Effects
            if (log.severity === "critical" || log.severity === "high") {
              this.drawAttackLine(0, log.geo);
              document.body.style.boxShadow =
                "inset 0 0 50px rgba(255,0,85,0.2)";
              setTimeout(() => (document.body.style.boxShadow = "none"), 500);
            }

            // AI Commentary
            if (log.severity === "critical") {
              this.writeAI(
                `CRITICAL EVENT DETECTED: ${log.msg}. Source: ${log.ip}. Initiating threat analysis.`
              );
            }
          }
        }

        // --- UI UPDATES ---
        updateStats() {
          document.getElementById("attackCount").innerText =
            document.querySelectorAll(".alert-item").length +
            this.backend.state.attacksBlocked;
          document.getElementById("riskScore").innerText =
            this.backend.state.riskScore;
          document.getElementById("logsPerSec").innerText =
            Math.floor(Math.random() * 50) + 100; // Fake fluctuation for effect
        }

        addLogToTable(log) {
          const tbody = document.getElementById("logTableBody");
          const row = document.createElement("tr");
          row.innerHTML = `
                    <td>${log.timestamp}</td>
                    <td class="text-info">${log.ip}</td>
                    <td>${log.geo}</td>
                    <td><span style="color:${this.getSeverityColor(
                      log.type
                    )}">${log.type.toUpperCase()}</span></td>
                    <td>${log.msg}</td>
                    <td><button class="btn btn-sm" onclick="App.enrich('${
                      log.ip
                    }')">Investigate</button></td>
                `;
          tbody.prepend(row); // Add to top
          // Limit table rows
          if (tbody.children.length > 20) tbody.lastElementChild.remove();
        }

        renderAlerts() {
          const container = document.getElementById("alertList");
          const alerts = this.backend.state.activeAlerts;

          if (alerts.length === 0) {
            container.innerHTML =
              '<div style="text-align:center; padding: 20px; color: var(--text-muted);">No active threats.</div>';
            return;
          }

          container.innerHTML = alerts
            .map(
              (alert) => `
                    <div class="alert-item ${
                      alert.severity
                    }" onclick="App.selectAlert('${alert.id}')">
                        <div class="alert-header">
                            <span>${alert.title}</span>
                            <span class="${
                              alert.severity === "critical"
                                ? "text-danger"
                                : "text-warn"
                            }">${alert.severity.toUpperCase()}</span>
                        </div>
                        <div class="alert-meta">
                            <span>IP: ${alert.ip}</span>
                            <span class="mitre-tag">${alert.mitre}</span>
                        </div>
                        <div style="margin-top:5px; color: #ccc;">${
                          alert.desc
                        }</div>
                        <button class="btn btn-sm btn-danger" style="margin-top:8px; width:100%" onclick="App.runSOAR('${
                          alert.ip
                        }')">Auto-Remediate (Block IP)</button>
                    </div>
                `
            )
            .join("");
        }

        writeAI(text) {
          const term = document.getElementById("ai-terminal");
          const msgDiv = document.createElement("div");
          msgDiv.className = "ai-msg";
          msgDiv.innerText = text;
          term.appendChild(msgDiv);
          term.scrollTop = term.scrollHeight;
        }

        // --- ACTIONS ---
        async enrich(ip) {
          const btn = event.target;
          const originalText = btn.innerText;
          btn.innerText = "Checking...";
          btn.disabled = true;

          const data = await this.backend.enrichIP(ip);

          this.writeAI(
            `[INTEL REPORT] IP ${ip} is flagged as MALICIOUS (Score: ${
              data.score
            }). Categories: ${data.categories.join(", ")}.`
          );

          btn.innerText = "Bad Actor";
          btn.style.borderColor = "var(--accent-danger)";
          btn.style.color = "var(--accent-danger)";
        }

        async runSOAR(ip) {
          // Stop event propagation to prevent alert selection
          event.stopPropagation();

          const consoleDiv = document.getElementById("soarConsole");
          const output = document.getElementById("soarOutput");
          consoleDiv.style.display = "block";
          output.innerHTML = "";

          const steps = await this.backend.executePlaybook("BLOCK IP", ip);

          for (let step of steps) {
            output.innerHTML += `<div style="margin-bottom:4px;">> ${step}</div>`;
            // Typing delay simulation
            await new Promise((r) => setTimeout(r, 600));
          }

          this.writeAI(
            `SOAR PLAYBOOK EXECUTED: IP ${ip} has been blocked on all firewalls.`
          );
          this.backend.state.attacksBlocked++;
          this.updateStats();

          setTimeout(() => {
            consoleDiv.style.display = "none";
          }, 4000);
        }

        selectAlert(id) {
          const alert = this.backend.state.activeAlerts.find(
            (a) => a.id === id
          );
          if (alert) {
            this.writeAI(
              `ANALYST FOCUS: Selected incident ${id}. Recommendation: ${alert.recommendation}`
            );
          }
        }

        clearAlerts() {
          this.backend.state.activeAlerts = [];
          this.renderAlerts();
          this.writeAI("Alert queue manually cleared by operator.");
        }

        triggerSOS() {
          document.body.style.background = "#300";
          setTimeout(
            () => (document.body.style.background = "var(--bg-dark)"),
            200
          );
          this.writeAI(
            "PANIC MODE ACTIVE. Isolating all subnets. Shutting down external ports."
          );
        }

        generateReport() {
          this.writeAI("Generating Incident PDF Report...");
          setTimeout(() => {
            alert("Simulated PDF Downloaded: 'Incident_Report_2023.pdf'");
          }, 1000);
        }

        getSeverityColor(type) {
          const colors = {
            auth: "#facc15",
            net: "#f87171",
            dns: "#60a5fa",
            file: "#c084fc",
          };
          return colors[type] || "#fff";
        }
      }

      // Initialize App
      const App = new FrontendApp();
    </script>
  </body>
</html>
