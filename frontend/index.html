<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CARDS | Intelligent SOC Platform</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  </head>
  <body>
    <header>
      <div class="logo">
        <div class="status-indicator"></div>
        C.A.R.D.S
      </div>
      <div style="display: flex; gap: 15px">
        <button class="btn" onclick="App.triggerSimulation()" id="simBtn">
          Start Simulation
        </button>
      </div>
    </header>

    <div class="main-container">
      <!-- SIDEBAR -->
      <nav class="sidebar panel">
        <div class="panel-title">Navigation</div>
        <div class="nav-item active" onclick="App.switchTab('Dashboard', this)">
          Dashboard
        </div>
        <div
          class="nav-item"
          onclick="App.switchTab('Threat Intelligence', this)"
        >
          Threat Intelligence
        </div>
        <div
          class="nav-item"
          onclick="App.switchTab('Incident Response', this)"
        >
          Incident Response
        </div>
        <div class="nav-item" onclick="App.switchTab('System Settings', this)">
          System Settings
        </div>

        <div class="panel-title" style="margin-top: 30px">System Health</div>
        <div
          style="
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 5px;
          "
        >
          CPU Load
        </div>
        <div
          style="
            width: 100%;
            height: 4px;
            background: #333;
            border-radius: 2px;
            margin-bottom: 15px;
          "
        >
          <div
            style="width: 34%; height: 100%; background: var(--accent-primary)"
          ></div>
        </div>
        <div
          style="
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 5px;
          "
        >
          Memory
        </div>
        <div
          style="width: 100%; height: 4px; background: #333; border-radius: 2px"
        >
          <div
            style="width: 62%; height: 100%; background: var(--accent-warn)"
          ></div>
        </div>

        <div class="panel-title" style="margin-top: 30px">Backend Status</div>
        <div id="backendStatus" class="text-warn" style="font-size: 0.75rem">
          Connecting to Node.js...
        </div>
      </nav>

      <!-- MAP SECTION (3D) -->
      <section class="map-section">
        <div id="threatMap"></div>
        <div class="overlay-stats">
          <div class="stat-card">
            <div class="stat-val text-danger" id="attackCount">0</div>
            <div class="stat-label">TOTAL ALERTS</div>
          </div>
          <div class="stat-card">
            <div class="stat-val text-warn" id="riskScore">0</div>
            <div class="stat-label">RISK SCORE</div>
          </div>
          <div class="stat-card">
            <div class="stat-val text-info" id="totalLogs">0</div>
            <div class="stat-label">TOTAL LOGS</div>
          </div>
        </div>
        <div class="soar-console" id="soarConsole">
          <div style="color: var(--accent-primary); margin-bottom: 5px">
            > SOAR PLAYBOOK EXECUTING...
          </div>
          <div id="soarOutput"></div>
        </div>
      </section>

      <!-- RIGHT PANEL -->
      <aside class="right-panel">
        <!-- AI -->
        <div class="ai-box panel">
          <div class="panel-title">
            <span>AI Incident Analyst</span
            ><span class="mono text-success">ONLINE</span>
          </div>
          <div id="ai-terminal">
            <div class="ai-msg">System initialized.</div>
            <div class="ai-msg">Connected to Node.js Backend.</div>
            <div class="ai-msg">Listening for security events...</div>
          </div>
        </div>

        <!-- SIMULATOR -->
        <div class="alert-box panel">
          <div class="panel-title"><span>Simulator (Testing)</span></div>
          <div
            style="
              padding: 10px;
              display: flex;
              flex-direction: column;
              gap: 8px;
            "
          >
            <div style="font-size: 0.75rem; color: var(--text-muted)">
              Simulate Login Attempts:
            </div>
            <div style="display: flex; gap: 5px">
              <button
                class="btn btn-sm"
                onclick="App.simLogin('admin', 'failed')"
              >
                + Fail
              </button>
              <button
                class="btn btn-sm"
                style="
                  border-color: var(--accent-secondary);
                  color: var(--accent-secondary);
                "
                onclick="App.simLogin('admin', 'success')"
              >
                + Success
              </button>
            </div>
          </div>
        </div>

        <!-- DATA & REPORTS -->
        <div class="alert-box panel">
          <div class="panel-title"><span>Security & Reports</span></div>
          <div
            style="
              padding: 10px;
              display: flex;
              flex-direction: column;
              gap: 10px;
            "
          >
            <div
              style="
                display: flex;
                align-items: center;
                justify-content: space-between;
              "
            >
              <span style="font-size: 0.8rem">Data Anonymization</span>
              <button
                class="btn btn-sm"
                id="privacyBtn"
                onclick="App.togglePrivacy()"
              >
                OFF
              </button>
            </div>
            <button
              class="btn btn-sm"
              style="width: 100%"
              onclick="App.exportReport()"
            >
              ðŸ“„ Download Incident Report
            </button>
          </div>
        </div>

        <!-- ALERTS -->
        <div class="alert-box panel">
          <div class="panel-title">
            <span>Active Alerts</span
            ><button class="btn btn-sm" onclick="App.clearAlerts()">
              Clear
            </button>
          </div>
          <div class="alert-list" id="alertList">
            <div
              style="
                text-align: center;
                padding: 20px;
                color: var(--text-muted);
              "
            >
              No active threats.
            </div>
          </div>
        </div>
      </aside>

      <!-- LOG TABLE -->
      <section class="log-section panel">
        <div class="panel-title">Universal Log Collector (Stream)</div>
        <div class="log-table-container">
          <table id="logTable">
            <thead>
              <tr>
                <th style="width: 150px">Timestamp</th>
                <th style="width: 120px">Source IP</th>
                <th style="width: 100px">User</th>
                <th style="width: 100px">Event</th>
                <th style="width: 80px">Status</th>
                <th style="width: 100px">Action</th>
              </tr>
            </thead>
            <tbody id="logTableBody"></tbody>
          </table>
        </div>
      </section>
    </div>

    <script>
      const API_BASE = "http://localhost:3000";
      let authToken = "Bearer demo-token"; // AUTHENTICATION BYPASSED
      let isPrivacyMode = false;

      class AudioController {
        constructor() {
          this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        }
        playTone(freq, type, duration, vol = 0.1) {
          if (this.ctx.state === "suspended") this.ctx.resume();
          const osc = this.ctx.createOscillator();
          const gain = this.ctx.createGain();
          osc.type = type;
          osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
          gain.gain.setValueAtTime(vol, this.ctx.currentTime);
          gain.gain.exponentialRampToValueAtTime(
            0.01,
            this.ctx.currentTime + duration
          );
          osc.connect(gain);
          gain.connect(this.ctx.destination);
          osc.start();
          osc.stop(this.ctx.currentTime + duration);
        }
        playClick() {
          this.playTone(800, "sine", 0.1, 0.05);
        }
        playAlert() {
          this.playTone(400, "square", 0.3, 0.1);
        }
        playSuccess() {
          this.playTone(600, "sine", 0.1, 0.05);
        }
        playSoar() {
          this.playTone(1000, "triangle", 0.2, 0.05);
        }
      }

      class Map3D {
        constructor() {
          this.container = document.getElementById("threatMap");
          this.scene = new THREE.Scene();
          this.scene.fog = new THREE.FogExp2(0x000000, 0.002);
          this.camera = new THREE.PerspectiveCamera(
            75,
            this.container.clientWidth / this.container.clientHeight,
            0.1,
            1000
          );
          this.camera.position.z = 45;
          this.camera.position.y = 15;
          this.camera.lookAt(0, 0, 0);
          this.renderer = new THREE.WebGLRenderer({
            alpha: true,
            antialias: true,
          });
          this.renderer.setSize(
            this.container.clientWidth,
            this.container.clientHeight
          );
          this.renderer.setPixelRatio(window.devicePixelRatio);
          this.container.appendChild(this.renderer.domElement);
          this.projectiles = [];
          this.falconGroup = null;
          this.initGrid();
          this.initFalcon();
          this.animate();
          window.addEventListener("resize", () => this.onResize());
        }

        initGrid() {
          const geometry = new THREE.IcosahedronGeometry(12, 2);
          const material = new THREE.MeshBasicMaterial({
            color: 0x00f2ff,
            wireframe: true,
            transparent: true,
            opacity: 0.15,
          });
          this.globe = new THREE.Mesh(geometry, material);
          this.scene.add(this.globe);
          const coreGeo = new THREE.IcosahedronGeometry(9, 1);
          const coreMat = new THREE.MeshBasicMaterial({ color: 0x050a14 });
          const core = new THREE.Mesh(coreGeo, coreMat);
          this.scene.add(core);
          const particlesGeo = new THREE.BufferGeometry();
          const particleCount = 500;
          const posArray = new Float32Array(particleCount * 3);
          for (let i = 0; i < particleCount * 3; i++)
            posArray[i] = (Math.random() - 0.5) * 60;
          particlesGeo.setAttribute(
            "position",
            new THREE.BufferAttribute(posArray, 3)
          );
          const particlesMat = new THREE.PointsMaterial({
            size: 0.2,
            color: 0x00f2ff,
            transparent: true,
            opacity: 0.5,
          });
          this.starField = new THREE.Points(particlesGeo, particlesMat);
          this.scene.add(this.starField);
        }

        initFalcon() {
          this.falconGroup = new THREE.Group();
          const falconMat = new THREE.MeshBasicMaterial({
            color: 0xffaa00,
            wireframe: true,
            transparent: true,
            opacity: 0.8,
          });
          const bodyGeo = new THREE.ConeGeometry(0.5, 2, 4);
          const body = new THREE.Mesh(bodyGeo, falconMat);
          body.rotation.x = Math.PI / 2;
          body.rotation.z = -Math.PI / 2;
          this.falconGroup.add(body);
          const wingGeo = new THREE.BufferGeometry();
          const vertices = new Float32Array([
            0, 0, 0, -2.5, 0, 1, -2.5, 0, -0.5, 0, 0, 0, 2.5, 0, 1, 2.5, 0,
            -0.5,
          ]);
          wingGeo.setAttribute(
            "position",
            new THREE.BufferAttribute(vertices, 3)
          );
          const wings = new THREE.Mesh(wingGeo, falconMat);
          this.falconGroup.add(wings);
          const engineGeo = new THREE.SphereGeometry(0.2, 8, 8);
          const engineMat = new THREE.MeshBasicMaterial({ color: 0xffaa00 });
          const engine = new THREE.Mesh(engineGeo, engineMat);
          engine.position.x = -1;
          this.falconGroup.add(engine);
          const beamGeo = new THREE.ConeGeometry(1, 5, 8, 1, true);
          const beamMat = new THREE.MeshBasicMaterial({
            color: 0xffaa00,
            transparent: true,
            opacity: 0.1,
            side: THREE.DoubleSide,
          });
          const beam = new THREE.Mesh(beamGeo, beamMat);
          beam.rotation.x = Math.PI / 2;
          beam.position.x = 2.5;
          this.falconGroup.add(beam);
          this.scene.add(this.falconGroup);
        }

        triggerAttack() {
          const geometry = new THREE.SphereGeometry(0.5, 8, 8);
          const material = new THREE.MeshBasicMaterial({ color: 0xff0055 });
          const projectile = new THREE.Mesh(geometry, material);
          const theta = Math.random() * Math.PI * 2;
          const phi = Math.acos(Math.random() * 2 - 1);
          const radius = 40;
          projectile.position.x = radius * Math.sin(phi) * Math.cos(theta);
          projectile.position.y = radius * Math.sin(phi) * Math.sin(theta);
          projectile.position.z = radius * Math.cos(phi);
          this.scene.add(projectile);
          this.projectiles.push({
            mesh: projectile,
            target: new THREE.Vector3(0, 0, 0),
          });
          this.globe.material.color.setHex(0xff0055);
          this.globe.material.opacity = 0.5;
          setTimeout(() => {
            this.globe.material.color.setHex(0x00f2ff);
            this.globe.material.opacity = 0.15;
          }, 300);
        }

        animate() {
          requestAnimationFrame(() => this.animate());
          this.globe.rotation.y += 0.002;
          this.starField.rotation.y -= 0.0005;
          if (this.falconGroup) {
            const time = Date.now() * 0.0005;
            const radius = 22;
            this.falconGroup.position.x = Math.cos(time) * radius;
            this.falconGroup.position.z = Math.sin(time) * radius;
            this.falconGroup.position.y = Math.sin(time * 2) * 3 + 5;
            this.falconGroup.lookAt(0, 0, 0);
          }
          for (let i = this.projectiles.length - 1; i >= 0; i--) {
            const p = this.projectiles[i];
            const direction = new THREE.Vector3()
              .subVectors(p.target, p.mesh.position)
              .normalize();
            p.mesh.position.add(direction.multiplyScalar(1.5));
            if (p.mesh.position.distanceTo(p.target) < 1) {
              this.scene.remove(p.mesh);
              this.projectiles.splice(i, 1);
            }
          }
          this.renderer.render(this.scene, this.camera);
        }

        onResize() {
          this.camera.aspect =
            this.container.clientWidth / this.container.clientHeight;
          this.camera.updateProjectionMatrix();
          this.renderer.setSize(
            this.container.clientWidth,
            this.container.clientHeight
          );
        }
      }

      class FrontendApp {
        constructor() {
          this.audio = new AudioController();
          this.map3d = new Map3D();
          this.lastAlertCount = 0;

          // START IMMEDIATELY - NO LOGIN REQUIRED
          this.startPolling();
        }

        switchTab(tabName, el) {
          document
            .querySelectorAll(".nav-item")
            .forEach((item) => item.classList.remove("active"));
          el.classList.add("active");
          this.writeAI(`Navigated to ${tabName}`);
        }

        startPolling() {
          setInterval(async () => {
            await this.updateDashboard();
            await this.updateLogs();
            await this.updateAlerts();
          }, 1000);
        }

        async updateDashboard() {
          try {
            const res = await fetch(`${API_BASE}/dashboard`);
            const data = await res.json();
            document.getElementById("totalLogs").innerText = data.totalLogs;
            document.getElementById("attackCount").innerText = data.totalAlerts;
            if (
              data.totalAlerts > this.lastAlertCount &&
              data.totalAlerts > 0
            ) {
              this.map3d.triggerAttack();
              this.audio.playAlert();
            }
            this.lastAlertCount = data.totalAlerts;
            document.getElementById("backendStatus").innerText = "â— Connected";
            document.getElementById("backendStatus").className =
              "mono text-success";
          } catch (error) {
            document.getElementById("backendStatus").innerText =
              "â— Disconnected";
            document.getElementById("backendStatus").className =
              "mono text-danger";
          }
        }

        async updateLogs() {
          try {
            const res = await fetch(
              `${API_BASE}/logs?anonymize=${isPrivacyMode}`
            );
            const logs = await res.json();
            this.renderLogs(logs);
          } catch (e) {
            console.error(e);
          }
        }

        async updateAlerts() {
          try {
            const res = await fetch(`${API_BASE}/alerts`);
            const alerts = await res.json();
            this.renderAlerts(alerts);
          } catch (e) {
            console.error(e);
          }
        }

        async simLogin(user, status) {
          this.audio.playClick();
          const ip = "192.168.1.55";
          try {
            await fetch(`${API_BASE}/submit-log`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ username: user, ip: ip, status: status }),
            });
            this.updateLogs();
          } catch (e) {
            this.writeAI("Simulation Failed");
          }
        }

        async triggerSimulation() {
          this.audio.playClick();
          this.writeAI("Initializing Simulation Sequence...");
          try {
            const res = await fetch(`${API_BASE}/simulate`, {
              method: "POST",
            });
            const data = await res.json();
            this.writeAI("Backend Simulation Triggered: " + data.message);
            this.updateLogs();
          } catch (error) {
            this.writeAI("ERROR: Could not contact backend.");
            this.audio.playAlert();
          }
        }

        togglePrivacy() {
          isPrivacyMode = !isPrivacyMode;
          const btn = document.getElementById("privacyBtn");
          if (isPrivacyMode) {
            btn.innerText = "ON";
            btn.style.background = "var(--accent-secondary)";
            btn.style.color = "#000";
            this.writeAI("Privacy Mode ENABLED: Logs anonymized.");
          } else {
            btn.innerText = "OFF";
            btn.style.background = "";
            btn.style.color = "";
            this.writeAI("Privacy Mode DISABLED: Real data shown.");
          }
          this.updateLogs();
        }

        exportReport() {
          this.audio.playClick();
          this.writeAI("Generating Incident Report...");
          setTimeout(() => {
            const content =
              "SOC INCIDENT REPORT\n====================\nGenerated: " +
              new Date().toLocaleString() +
              "\nTotal Alerts: " +
              document.getElementById("attackCount").innerText +
              "\n\nNOTE: This is a generated JSON summary of current alert state.";
            const blob = new Blob([content], { type: "text/plain" });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `SOC_Report_${Date.now()}.txt`;
            a.click();
            this.writeAI("Report Downloaded successfully.");
          }, 1000);
        }

        renderLogs(logs) {
          const tbody = document.getElementById("logTableBody");
          const recentLogs = logs.slice(-20).reverse();
          tbody.innerHTML = recentLogs
            .map(
              (log) => `
            <tr>
              <td>${log.time}</td>
              <td class="text-info">${log.ip}</td>
              <td>${log.username}</td>
              <td>${log.event}</td>
              <td><span class="${
                log.status === "success" ? "text-success" : "text-danger"
              }">${log.status.toUpperCase()}</span></td>
              <td><button class="btn btn-sm" onclick="App.enrich('${
                log.ip
              }')">Investigate</button></td>
            </tr>
          `
            )
            .join("");
        }

        renderAlerts(alerts) {
          const container = document.getElementById("alertList");
          if (alerts.length === 0) {
            container.innerHTML =
              '<div style="text-align:center; padding: 20px; color: var(--text-muted);">No active threats.</div>';
            return;
          }
          container.innerHTML = alerts
            .map(
              (alert) => `
            <div class="alert-item ${alert.severity}">
              <div class="alert-header"><span>BRUTE FORCE DETECTED</span><span class="${
                alert.severity === "Critical" ? "text-danger" : "text-warn"
              }">SCORE: ${alert.riskScore}</span></div>
              <div class="alert-meta"><span>IP: ${alert.ip}</span></div>
              <div style="margin-top:8px; font-size:0.75rem; font-style:italic; color:#aaa;">"${
                alert.summary
              }"</div>
              <button class="btn btn-sm btn-danger" style="margin-top:8px; width:100%" onclick="App.runSOAR('${
                alert.ip
              }')">Auto-Remediate</button>
            </div>
          `
            )
            .join("");
          if (alerts.length > 0)
            this.writeAI(`[ANALYSIS] ${alerts[0].summary}`);
        }

        enrich(ip) {
          this.audio.playClick();
          const btn = event.target;
          btn.innerText = "Checking...";
          btn.disabled = true;
          setTimeout(() => {
            btn.innerText = "Malicious";
            btn.style.borderColor = "var(--accent-danger)";
            btn.style.color = "var(--accent-danger)";
            this.writeAI(`External Threat Intel confirms IP ${ip} is hostile.`);
          }, 800);
        }

        runSOAR(ip) {
          event.stopPropagation();
          this.audio.playSoar();
          const consoleDiv = document.getElementById("soarConsole");
          const output = document.getElementById("soarOutput");
          consoleDiv.style.display = "block";
          output.innerHTML = "";
          const steps = [
            `Isolating Host...`,
            `Blocking IP ${ip} on Firewall...`,
            `Terminating Sessions...`,
            `Success.`,
          ];
          let stepIndex = 0;
          const interval = setInterval(() => {
            if (stepIndex >= steps.length) {
              clearInterval(interval);
              this.audio.playSuccess();
              this.writeAI(`SOAR PLAYBOOK EXECUTED for ${ip}`);
              setTimeout(() => {
                consoleDiv.style.display = "none";
              }, 3000);
              return;
            }
            output.innerHTML += `<div style="margin-bottom:4px;">> ${steps[stepIndex]}</div>`;
            stepIndex++;
          }, 600);
        }

        clearAlerts() {
          this.audio.playClick();
          document.getElementById("alertList").innerHTML =
            '<div style="text-align:center; padding: 20px; color: var(--text-muted);">No active threats.</div>';
          this.writeAI("Alerts manually acknowledged.");
        }

        writeAI(text) {
          const term = document.getElementById("ai-terminal");
          const msgDiv = document.createElement("div");
          msgDiv.className = "ai-msg";
          msgDiv.innerText = text;
          term.appendChild(msgDiv);
          term.scrollTop = term.scrollHeight;
        }
      }

      const App = new FrontendApp();
    </script>
  </body>
</html>
