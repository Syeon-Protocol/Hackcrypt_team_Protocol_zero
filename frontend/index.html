<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CARDS | Intelligent SOC Platform</title>

    <!-- CSS Link -->
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- Three.js Library for 3D Map -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  </head>
  <body>
    <header>
      <div class="logo">
        <div class="status-indicator"></div>
        C.A.R.D.S
      </div>
      <div style="display: flex; gap: 15px">
        <button class="btn" onclick="App.triggerSimulation()" id="simBtn">
          Start Simulation
        </button>
        <button class="btn btn-danger" onclick="App.triggerSOS()">
          PANIC MODE
        </button>
      </div>
    </header>

    <div class="main-container">
      <!-- SIDEBAR -->
      <nav class="sidebar panel">
        <div class="panel-title">Navigation</div>
        <div class="nav-item active">Dashboard</div>
        <div class="nav-item">Threat Intelligence</div>
        <div class="nav-item">Incident Response</div>
        <div class="nav-item">System Settings</div>

        <div class="panel-title" style="margin-top: 30px">System Health</div>
        <div
          style="
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 5px;
          "
        >
          CPU Load
        </div>
        <div
          style="
            width: 100%;
            height: 4px;
            background: #333;
            border-radius: 2px;
            margin-bottom: 15px;
          "
        >
          <div
            style="width: 34%; height: 100%; background: var(--accent-primary)"
          ></div>
        </div>
        <div
          style="
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 5px;
          "
        >
          Memory
        </div>
        <div
          style="width: 100%; height: 4px; background: #333; border-radius: 2px"
        >
          <div
            style="width: 62%; height: 100%; background: var(--accent-warn)"
          ></div>
        </div>

        <div class="panel-title" style="margin-top: 30px">Backend Status</div>
        <div id="backendStatus" class="text-warn" style="font-size: 0.75rem">
          Connecting to Node.js...
        </div>
      </nav>

      <!-- MAP SECTION (3D) -->
      <section class="map-section">
        <div id="threatMap"></div>
        <div class="overlay-stats">
          <div class="stat-card">
            <div class="stat-val text-danger" id="attackCount">0</div>
            <div class="stat-label">TOTAL ALERTS</div>
          </div>
          <div class="stat-card">
            <div class="stat-val text-warn" id="riskScore">0</div>
            <div class="stat-label">RISK SCORE</div>
          </div>
          <div class="stat-card">
            <div class="stat-val text-info" id="totalLogs">0</div>
            <div class="stat-label">TOTAL LOGS</div>
          </div>
        </div>

        <!-- SOAR CONSOLE -->
        <div class="soar-console" id="soarConsole">
          <div style="color: var(--accent-primary); margin-bottom: 5px">
            > SOAR PLAYBOOK EXECUTING...
          </div>
          <div id="soarOutput"></div>
        </div>
      </section>

      <!-- RIGHT PANEL -->
      <aside class="right-panel">
        <!-- JARVIS AI -->
        <div class="ai-box panel">
          <div class="panel-title">
            <span>AI Incident Analyst</span>
            <span class="mono text-success">ONLINE</span>
          </div>
          <div id="ai-terminal">
            <div class="ai-msg">System initialized.</div>
            <div class="ai-msg">Connected to Node.js Backend.</div>
            <div class="ai-msg">Listening for security events...</div>
          </div>
        </div>

        <!-- ALERT QUEUE -->
        <div class="alert-box panel">
          <div class="panel-title">
            <span>Active Alerts</span>
            <button class="btn btn-sm" onclick="App.clearAlerts()">
              Clear
            </button>
          </div>
          <div class="alert-list" id="alertList">
            <div
              style="
                text-align: center;
                padding: 20px;
                color: var(--text-muted);
              "
            >
              No active threats.
            </div>
          </div>
        </div>
      </aside>

      <!-- LOG TABLE -->
      <section class="log-section panel">
        <div class="panel-title">Universal Log Collector (Stream)</div>
        <div class="log-table-container">
          <table id="logTable">
            <thead>
              <tr>
                <th style="width: 150px">Timestamp</th>
                <th style="width: 120px">Source IP</th>
                <th style="width: 100px">User</th>
                <th style="width: 100px">Event</th>
                <th style="width: 80px">Status</th>
                <th style="width: 100px">Action</th>
              </tr>
            </thead>
            <tbody id="logTableBody">
              <!-- Logs injected here -->
            </tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- --- JAVASCRIPT LOGIC --- -->
    <script>
      /*
       * ====================================================================
       * AUDIO CONTROLLER
       * ====================================================================
       */
      class AudioController {
        constructor() {
          this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        }
        playTone(freq, type, duration, vol = 0.1) {
          if (this.ctx.state === "suspended") this.ctx.resume();
          const osc = this.ctx.createOscillator();
          const gain = this.ctx.createGain();
          osc.type = type;
          osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
          gain.gain.setValueAtTime(vol, this.ctx.currentTime);
          gain.gain.exponentialRampToValueAtTime(
            0.01,
            this.ctx.currentTime + duration
          );
          osc.connect(gain);
          gain.connect(this.ctx.destination);
          osc.start();
          osc.stop(this.ctx.currentTime + duration);
        }
        playClick() {
          this.playTone(800, "sine", 0.1, 0.05);
        }
        playAlert() {
          this.playTone(400, "square", 0.3, 0.1);
          setTimeout(() => this.playTone(300, "sawtooth", 0.4, 0.1), 150);
        }
        playSuccess() {
          this.playTone(600, "sine", 0.1, 0.05);
          setTimeout(() => this.playTone(1200, "sine", 0.3, 0.05), 100);
        }
      }

      /*
       * ====================================================================
       * 3D MAP VISUALIZATION (Three.js)
       * ====================================================================
       */
      /*
       * ====================================================================
       * 3D MAP VISUALIZATION (Three.js) - WITH FALCON
       * ====================================================================
       */
      class Map3D {
        constructor() {
          this.container = document.getElementById("threatMap");
          this.scene = new THREE.Scene();
          this.scene.fog = new THREE.FogExp2(0x000000, 0.002);

          this.camera = new THREE.PerspectiveCamera(
            75,
            this.container.clientWidth / this.container.clientHeight,
            0.1,
            1000
          );
          this.camera.position.z = 45; // Zoomed out slightly to see the Falcon
          this.camera.position.y = 15;
          this.camera.lookAt(0, 0, 0);

          this.renderer = new THREE.WebGLRenderer({
            alpha: true,
            antialias: true,
          });
          this.renderer.setSize(
            this.container.clientWidth,
            this.container.clientHeight
          );
          this.renderer.setPixelRatio(window.devicePixelRatio);
          this.container.appendChild(this.renderer.domElement);

          this.projectiles = [];
          this.falconGroup = null; // Will hold our falcon mesh

          this.initGrid();
          this.initFalcon(); // Initialize the Falcon
          this.animate();

          window.addEventListener("resize", () => this.onResize());
        }

        initGrid() {
          // Create wireframe globe
          const geometry = new THREE.IcosahedronGeometry(12, 2);
          const material = new THREE.MeshBasicMaterial({
            color: 0x00f2ff,
            wireframe: true,
            transparent: true,
            opacity: 0.15,
          });
          this.globe = new THREE.Mesh(geometry, material);
          this.scene.add(this.globe);

          // Inner core
          const coreGeo = new THREE.IcosahedronGeometry(9, 1);
          const coreMat = new THREE.MeshBasicMaterial({ color: 0x050a14 });
          const core = new THREE.Mesh(coreGeo, coreMat);
          this.scene.add(core);

          // Ambient particles
          const particlesGeo = new THREE.BufferGeometry();
          const particleCount = 500;
          const posArray = new Float32Array(particleCount * 3);
          for (let i = 0; i < particleCount * 3; i++) {
            posArray[i] = (Math.random() - 0.5) * 60;
          }
          particlesGeo.setAttribute(
            "position",
            new THREE.BufferAttribute(posArray, 3)
          );
          const particlesMat = new THREE.PointsMaterial({
            size: 0.2,
            color: 0x00f2ff,
            transparent: true,
            opacity: 0.5,
          });
          this.starField = new THREE.Points(particlesGeo, particlesMat);
          this.scene.add(this.starField);
        }

        // --- NEW: FALCON CREATION ---
        initFalcon() {
          this.falconGroup = new THREE.Group();

          // Cyber Orange/Gold Material
          const falconMat = new THREE.MeshBasicMaterial({
            color: 0xffaa00,
            wireframe: true,
            transparent: true,
            opacity: 0.8,
          });

          // 1. Body (Aerodynamic Cone)
          const bodyGeo = new THREE.ConeGeometry(0.5, 2, 4);
          const body = new THREE.Mesh(bodyGeo, falconMat);
          body.rotation.x = Math.PI / 2;
          body.rotation.z = -Math.PI / 2; // Point forward
          this.falconGroup.add(body);

          // 2. Wings (Deltoid Shape)
          const wingGeo = new THREE.BufferGeometry();
          const vertices = new Float32Array([
            0,
            0,
            0, // Root
            -2.5,
            0,
            1, // Tip Left
            -2.5,
            0,
            -0.5, // Back Left
            0,
            0,
            0, // Root
            2.5,
            0,
            1, // Tip Right
            2.5,
            0,
            -0.5, // Back Right
          ]);
          wingGeo.setAttribute(
            "position",
            new THREE.BufferAttribute(vertices, 3)
          );
          const wings = new THREE.Mesh(wingGeo, falconMat);
          this.falconGroup.add(wings);

          // 3. Engine Glow
          const engineGeo = new THREE.SphereGeometry(0.2, 8, 8);
          const engineMat = new THREE.MeshBasicMaterial({ color: 0xffaa00 });
          const engine = new THREE.Mesh(engineGeo, engineMat);
          engine.position.x = -1; // Back of bird
          this.falconGroup.add(engine);

          // 4. Scanner Beam (Visual touch)
          const beamGeo = new THREE.ConeGeometry(1, 5, 8, 1, true);
          const beamMat = new THREE.MeshBasicMaterial({
            color: 0xffaa00,
            transparent: true,
            opacity: 0.1,
            side: THREE.DoubleSide,
          });
          const beam = new THREE.Mesh(beamGeo, beamMat);
          beam.rotation.x = Math.PI / 2;
          beam.position.x = 2.5; // Front of bird
          this.falconGroup.add(beam);

          this.scene.add(this.falconGroup);
        }

        triggerAttack() {
          // Red projectile
          const geometry = new THREE.SphereGeometry(0.5, 8, 8);
          const material = new THREE.MeshBasicMaterial({ color: 0xff0055 });
          const projectile = new THREE.Mesh(geometry, material);

          const theta = Math.random() * Math.PI * 2;
          const phi = Math.acos(Math.random() * 2 - 1);
          const radius = 40;

          projectile.position.x = radius * Math.sin(phi) * Math.cos(theta);
          projectile.position.y = radius * Math.sin(phi) * Math.sin(theta);
          projectile.position.z = radius * Math.cos(phi);

          this.scene.add(projectile);
          this.projectiles.push({
            mesh: projectile,
            target: new THREE.Vector3(0, 0, 0),
          });

          // Flash Globe
          this.globe.material.color.setHex(0xff0055);
          this.globe.material.opacity = 0.5;
          setTimeout(() => {
            this.globe.material.color.setHex(0x00f2ff);
            this.globe.material.opacity = 0.15;
          }, 300);
        }

        animate() {
          requestAnimationFrame(() => this.animate());

          // Rotate Globe & Stars
          this.globe.rotation.y += 0.002;
          this.starField.rotation.y -= 0.0005;

          // --- FALCON ANIMATION ---
          if (this.falconGroup) {
            const time = Date.now() * 0.0005;
            const radius = 22; // Orbit radius

            // Circular Orbit
            this.falconGroup.position.x = Math.cos(time) * radius;
            this.falconGroup.position.z = Math.sin(time) * radius;

            // Gentle Bobbing (Altitude)
            this.falconGroup.position.y = Math.sin(time * 2) * 3 + 5;

            // Always face the center (Scanning)
            this.falconGroup.lookAt(0, 0, 0);
          }

          // Animate Projectiles
          for (let i = this.projectiles.length - 1; i >= 0; i--) {
            const p = this.projectiles[i];
            const direction = new THREE.Vector3()
              .subVectors(p.target, p.mesh.position)
              .normalize();
            p.mesh.position.add(direction.multiplyScalar(1.5));
            if (p.mesh.position.distanceTo(p.target) < 1) {
              this.scene.remove(p.mesh);
              this.projectiles.splice(i, 1);
            }
          }

          this.renderer.render(this.scene, this.camera);
        }

        onResize() {
          this.camera.aspect =
            this.container.clientWidth / this.container.clientHeight;
          this.camera.updateProjectionMatrix();
          this.renderer.setSize(
            this.container.clientWidth,
            this.container.clientHeight
          );
        }
      }

      /*
       * ====================================================================
       * FRONTEND UI & API INTEGRATION
       * ====================================================================
       */
      const API_BASE = "http://localhost:3000";

      class FrontendApp {
        constructor() {
          this.audio = new AudioController();
          this.map3d = new Map3D();
          this.lastAlertCount = 0;

          // Start polling for data
          this.startPolling();
        }

        startPolling() {
          // Check dashboard stats, logs, and alerts every 1 second
          setInterval(async () => {
            await this.updateDashboard();
            await this.updateLogs();
            await this.updateAlerts();
          }, 1000);
        }

        async updateDashboard() {
          try {
            const res = await fetch(`${API_BASE}/dashboard`);
            const data = await res.json();

            document.getElementById("totalLogs").innerText = data.totalLogs;
            document.getElementById("attackCount").innerText = data.totalAlerts;

            // If alerts increased significantly, trigger sound/visuals
            if (
              data.totalAlerts > this.lastAlertCount &&
              data.totalAlerts > 0
            ) {
              this.map3d.triggerAttack();
              this.audio.playAlert();
            }
            this.lastAlertCount = data.totalAlerts;

            document.getElementById("backendStatus").innerText = "● Connected";
            document.getElementById("backendStatus").className =
              "mono text-success";
          } catch (error) {
            document.getElementById("backendStatus").innerText =
              "● Disconnected (Backend not running)";
            document.getElementById("backendStatus").className =
              "mono text-danger";
          }
        }

        async updateLogs() {
          try {
            const res = await fetch(`${API_BASE}/logs`);
            const logs = await res.json();
            this.renderLogs(logs);
          } catch (e) {
            console.error("Logs error", e);
          }
        }

        async updateAlerts() {
          try {
            const res = await fetch(`${API_BASE}/alerts`);
            const alerts = await res.json();
            this.renderAlerts(alerts);
          } catch (e) {
            console.error("Alerts error", e);
          }
        }

        async triggerSimulation() {
          this.audio.playClick();
          this.writeAI("Initializing Simulation Sequence...");
          try {
            const res = await fetch(`${API_BASE}/simulate`, { method: "POST" });
            const data = await res.json();
            this.writeAI("Backend Simulation Triggered: " + data.message);
            // Force a quick refresh
            this.updateLogs();
          } catch (error) {
            this.writeAI(
              "ERROR: Could not contact backend. Is server.js running?"
            );
            this.audio.playAlert();
          }
        }

        renderLogs(logs) {
          const tbody = document.getElementById("logTableBody");
          // Only render the last 20 logs for performance
          const recentLogs = logs.slice(-20).reverse();

          tbody.innerHTML = recentLogs
            .map(
              (log) => `
                    <tr>
                        <td>${new Date(log.time).toLocaleTimeString()}</td>
                        <td class="text-info">${log.ip}</td>
                        <td>${log.username}</td>
                        <td>${log.event}</td>
                        <td><span class="${
                          log.status === "success"
                            ? "text-success"
                            : "text-danger"
                        }">${log.status.toUpperCase()}</span></td>
                        <td><button class="btn btn-sm" onclick="App.enrich('${
                          log.ip
                        }')">Investigate</button></td>
                    </tr>
                `
            )
            .join("");
        }

        renderAlerts(alerts) {
          const container = document.getElementById("alertList");

          // Only update if content actually changed to avoid flickering
          // (Simple hash check could be better, but this suffices for demo)
          if (
            container.childElementCount === alerts.length + 1 &&
            alerts.length > 0
          )
            return;

          if (alerts.length === 0) {
            container.innerHTML =
              '<div style="text-align:center; padding: 20px; color: var(--text-muted);">No active threats.</div>';
            return;
          }

          container.innerHTML = alerts
            .map(
              (alert) => `
                    <div class="alert-item ${alert.severity}">
                        <div class="alert-header">
                            <span>BRUTE FORCE DETECTED</span>
                            <span class="${
                              alert.severity === "Critical"
                                ? "text-danger"
                                : "text-warn"
                            }">SCORE: ${alert.riskScore}</span>
                        </div>
                        <div class="alert-meta">
                            <span>IP: ${alert.ip}</span>
                            <span>${alert.investigation.country}</span>
                        </div>
                        <div class="alert-details" style="margin-top:5px; color: #ff6b6b;">
                            Rep: ${
                              alert.investigation.reputation
                            } | Blacklisted: ${alert.investigation.blacklisted}
                        </div>
                        <div style="margin-top:8px; font-size:0.75rem; font-style:italic; color:#aaa;">
                            "${alert.summary}"
                        </div>
                        <button class="btn btn-sm btn-danger" style="margin-top:8px; width:100%" onclick="App.runSOAR('${
                          alert.ip
                        }')">Auto-Remediate</button>
                    </div>
                `
            )
            .join("");

          // If there is a new alert, put its summary in the AI Terminal
          if (alerts.length > 0) {
            const latestAlert = alerts[0];
            this.writeAI(`[ANALYSIS] ${latestAlert.summary}`);
          }
        }

        writeAI(text) {
          const term = document.getElementById("ai-terminal");
          const msgDiv = document.createElement("div");
          msgDiv.className = "ai-msg";
          msgDiv.innerText = text;
          term.appendChild(msgDiv);
          term.scrollTop = term.scrollHeight;
        }

        enrich(ip) {
          this.audio.playClick();
          const btn = event.target;
          btn.innerText = "Checking...";
          btn.disabled = true;
          // Mocking enrichment since backend doesn't have a specific /enrich endpoint for IP
          setTimeout(() => {
            btn.innerText = "Malicious";
            btn.style.borderColor = "var(--accent-danger)";
            btn.style.color = "var(--accent-danger)";
            this.writeAI(`External Threat Intel confirms IP ${ip} is hostile.`);
          }, 800);
        }

        runSOAR(ip) {
          event.stopPropagation();
          this.audio.playSoar();
          const consoleDiv = document.getElementById("soarConsole");
          const output = document.getElementById("soarOutput");
          consoleDiv.style.display = "block";
          output.innerHTML = "";
          const steps = [
            `Isolating Host...`,
            `Blocking IP ${ip} on Firewall...`,
            `Terminating Sessions...`,
            `Success.`,
          ];
          let stepIndex = 0;
          const interval = setInterval(() => {
            if (stepIndex >= steps.length) {
              clearInterval(interval);
              this.audio.playSuccess();
              this.writeAI(`SOAR PLAYBOOK EXECUTED for ${ip}`);
              setTimeout(() => {
                consoleDiv.style.display = "none";
              }, 3000);
              return;
            }
            output.innerHTML += `<div style="margin-bottom:4px;">> ${steps[stepIndex]}</div>`;
            stepIndex++;
          }, 600);
        }

        clearAlerts() {
          this.audio.playClick();
          // Note: Your backend doesn't have a "clear alerts" endpoint, so we just clear frontend visual
          document.getElementById("alertList").innerHTML =
            '<div style="text-align:center; padding: 20px; color: var(--text-muted);">No active threats.</div>';
          this.writeAI("Alerts manually acknowledged.");
          // To fully clear backend, you would need to add a DELETE endpoint to server.js
        }

        triggerSOS() {
          this.audio.playAlert();
          document.body.style.background = "#300";
          setTimeout(
            () => (document.body.style.background = "var(--bg-dark)"),
            200
          );
          this.writeAI("PANIC MODE ACTIVE. All external ports closed.");
        }
      }

      // Initialize App
      const App = new FrontendApp();
    </script>
  </body>
</html>
